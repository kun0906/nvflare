import os
import pickle

import matplotlib.pyplot as plt
import numpy as np
import pandas as pd


def plot_dropout(results={}):
    fig, ax = plt.subplots()
    FONTSIZE = 10

    makers = ['o', '+', 's', '*', 'v', '.', 'p', 'h', 'x', '8', '1', '^', 'D', 'd']
    for i, (agg_method, vs) in enumerate(results.items()):
        label = agg_method
        if label == 'rkrum':
            label = 'rKrum'
        elif label == 'krum':
            label = 'Krum'
        elif label == 'mean':
            label = 'Mean'
        else:
            pass
        # ys, ys_errs = zip(*vs)
        ys = vs
        xs = range(len(ys))
        print(agg_method, ys, flush=True)

        # plt.plot(xs, ys, label=label, marker=makers[i])
        # axes[i_row, j_col].plot(xs, ys, label=label, marker=makers[i])
        # axes[i_row, j_col].errorbar(xs, ys, yerr=ys_errs, label=label, marker=makers[i], capsize=3)
        plt.plot(xs, ys, label=label, marker=makers[i])  # Plot the line
        # axes[i_row, j_col].fill_between(xs,
        #                                 [y - e for y, e in zip(ys, ys_errs)],
        #                                 [y + e for y, e in zip(ys, ys_errs)],
        #                                 color='blue', alpha=0.3)  # label='Error Area'
    plt.xlabel('Communication Round', fontsize=FONTSIZE)
    if len(xs) > 20:
        # Show ticks every 20 rounds (e.g., 0, 19, 39...) but add +1 to make labels human-friendly (1-based)
        xs_labels = [(i, i + 1) for i in xs if (i + 1) % 10 == 0 or i == 0]
    else:
        xs_labels = [(i, i + 1) for i in xs]
    # Unzip into positions and labels
    xticks, xticklabels = zip(*xs_labels)
    ax.set_xticks(xticks)
    ax.set_xticklabels(xticklabels)
    # if METRIC == 'loss':
    #     plt.ylabel('Loss', fontsize=FONTSIZE)
    # elif METRIC == 'l2_error':
    #     plt.ylabel('L_2 Error', fontsize=FONTSIZE)
    # elif METRIC == 'time_taken':
    #     plt.ylabel('Time Taken', fontsize=FONTSIZE)
    # elif METRIC == 'misclassification_error':
    #     plt.ylabel('Misclassification Error', fontsize=FONTSIZE)
    # else:
    #     plt.ylabel('Accuracy')
    plt.ylabel('Accuracy')
    # plt.title(f'Global Model ({JOBID}), start:{start}, {title}', fontsize=10)
    plt.legend(fontsize=FONTSIZE, loc='best')

    # attacker_ratio = NUM_BYZANTINE_CLIENTS / (NUM_HONEST_CLIENTS + NUM_BYZANTINE_CLIENTS)
    # title = (f'{model_type}_cnn' + '$_{' + f'{num_server_epoches}+1' + '}$' +
    #          f':{attacker_ratio:.2f}-{LABELING_RATE:.2f}')

    # Adjust layout to prevent overlap
    plt.tight_layout()
    # fig_file = (f'{IN_DIR}/{model_type}_{LABELING_RATE}_{AGGREGATION_METHOD}_'
    #             f'{SERVER_EPOCHS}_{NUM_HONEST_CLIENTS}_{NUM_BYZANTINE_CLIENTS}_accuracy.png')
    fig_file = f'plots/{dropout_type}.png'
    os.makedirs(os.path.dirname(fig_file), exist_ok=True)
    plt.savefig(fig_file, dpi=300)
    plt.show()
    plt.close()


if __name__ == '__main__':
    # Total of 20 clients: 8 Byzantine and 12 honest

    # case = 'case 3'
    # if case == 'case 1':
    #     # Uniform Distribution
    #     # Case 1: In each training round, 80% of clients (i.e., 16 clients) are randomly selected to participate
    #
    #     # # ** *random_seed: 0
    #     # rkrum = [0.754, 0.77, 0.772, 0.766, 0.78, 0.774, 0.752, 0.76, 0.798, 0.772, 0.806, 0.784, 0.78, 0.772, 0.77,
    #     #          0.762, 0.75, 0.746, 0.75, 0.778, 0.76, 0.756, 0.738, 0.736, 0.746, 0.766, 0.728, 0.736, 0.732, 0.75]
    #     # krum = [0.754, 0.772, 0.778, 0.768, 0.768, 0.768, 0.756, 0.754, 0.76, 0.748, 0.744, 0.768, 0.756, 0.744, 0.764,
    #     #         0.748, 0.722, 0.744, 0.752, 0.734, 0.746, 0.738, 0.728, 0.7, 0.718, 0.744, 0.738, 0.704, 0.734, 0.736]
    #     # mean = [0.508, 0.556, 0.492, 0.472, 0.424, 0.508, 0.492, 0.482, 0.456, 0.44, 0.418, 0.412, 0.42, 0.45, 0.456,
    #     #         0.462, 0.486, 0.478, 0.502, 0.464, 0.452, 0.468, 0.468, 0.496, 0.47, 0.468, 0.48, 0.466, 0.486, 0.466]
    #     # # rkrum = 35922555992
    #     # # krum = 17843826133
    #     # # mean = 17868847436
    #
    #     # # ** *random_seed: 100
    #     # rkrum = [0.744, 0.772, 0.79, 0.77, 0.766, 0.786, 0.776, 0.764, 0.772, 0.762, 0.76, 0.762, 0.766, 0.75, 0.742,
    #     #          0.744, 0.744, 0.736, 0.702, 0.724, 0.708, 0.71, 0.714, 0.71, 0.726, 0.742, 0.722, 0.726, 0.732, 0.73]
    #     # krum = [0.71, 0.76, 0.768, 0.784, 0.762, 0.778, 0.758, 0.764, 0.76, 0.746, 0.76, 0.748, 0.732, 0.76, 0.724,
    #     #         0.718, 0.734, 0.706, 0.732, 0.712, 0.706, 0.708, 0.722, 0.71, 0.702, 0.712, 0.714, 0.704, 0.712, 0.714]
    #     # mean = [0.502, 0.462, 0.494, 0.474, 0.518, 0.53, 0.538, 0.506, 0.452, 0.494, 0.49, 0.466, 0.468, 0.5, 0.49,
    #     #         0.494, 0.506, 0.504, 0.492, 0.516, 0.476, 0.488, 0.536, 0.528, 0.498, 0.506, 0.472, 0.48, 0.508, 0.496]
    #     # # rkrum = 18129568144
    #     # # krum = 17911906579
    #     # # mean = 17973028938
    #
    #     # # ** *random_seed: 200
    #     # rkrum = [0.736, 0.762, 0.774, 0.78, 0.766, 0.766, 0.76, 0.756, 0.766, 0.746, 0.778, 0.76, 0.758, 0.76, 0.784,
    #     #          0.75, 0.756, 0.754, 0.768, 0.762, 0.788, 0.764, 0.764, 0.766, 0.748, 0.748, 0.76, 0.75, 0.748, 0.746]
    #     # krum = [0.774, 0.774, 0.77, 0.758, 0.782, 0.758, 0.762, 0.762, 0.762, 0.746, 0.756, 0.74, 0.746, 0.74, 0.726,
    #     #         0.734, 0.724, 0.748, 0.758, 0.73, 0.73, 0.746, 0.714, 0.726, 0.718, 0.724, 0.738, 0.726, 0.72, 0.7]
    #     # mean = [0.44, 0.462, 0.504, 0.51, 0.556, 0.502, 0.52, 0.486, 0.522, 0.524, 0.522, 0.536, 0.56, 0.572, 0.558,
    #     #         0.546, 0.576, 0.562, 0.55, 0.552, 0.57, 0.524, 0.546, 0.514, 0.514, 0.526, 0.528, 0.5, 0.498, 0.532]
    #     # # rkrum = 18135682858
    #     # # krum = 18156062744
    #     # # mean = 18228552723
    #
    #     # ** *random_seed: 300
    #     rkrum = [0.75, 0.754, 0.78, 0.78, 0.78, 0.76, 0.77, 0.766, 0.768, 0.776, 0.774, 0.764, 0.762, 0.77, 0.758,
    #              0.758, 0.774, 0.766, 0.758, 0.736, 0.764, 0.762, 0.748, 0.74, 0.752, 0.734, 0.736, 0.728, 0.734, 0.75]
    #     krum = [0.74, 0.764, 0.77, 0.76, 0.784, 0.774, 0.78, 0.78, 0.778, 0.758, 0.776, 0.746, 0.756, 0.758, 0.762,
    #             0.75, 0.734, 0.756, 0.748, 0.742, 0.738, 0.726, 0.74, 0.728, 0.762, 0.716, 0.74, 0.75, 0.738, 0.728]
    #     mean = [0.554, 0.53, 0.484, 0.562, 0.56, 0.538, 0.514, 0.498, 0.538, 0.512, 0.51, 0.522, 0.504, 0.508, 0.524,
    #             0.52, 0.512, 0.482, 0.494, 0.524, 0.528, 0.542, 0.498, 0.518, 0.522, 0.538, 0.534, 0.546, 0.55, 0.544]
    #     # rkrum = 17709281176
    #     # krum = 17648004246
    #     # mean = 17827430401
    #
    #     # # ** *random_seed: 400
    #     # rkrum = [0.728, 0.732, 0.776, 0.778, 0.776, 0.782, 0.786, 0.754, 0.776, 0.768, 0.774, 0.766, 0.766, 0.75, 0.744,
    #     #          0.74, 0.762, 0.754, 0.76, 0.76, 0.744, 0.728, 0.73, 0.756, 0.724, 0.742, 0.75, 0.746, 0.758, 0.75]
    #     # krum = [0.742, 0.764, 0.77, 0.774, 0.76, 0.766, 0.766, 0.76, 0.754, 0.764, 0.748, 0.768, 0.754, 0.756, 0.73,
    #     #         0.738, 0.724, 0.712, 0.712, 0.73, 0.744, 0.72, 0.736, 0.71, 0.732, 0.748, 0.728, 0.728, 0.718, 0.73]
    #     # mean = [0.482, 0.456, 0.46, 0.446, 0.518, 0.506, 0.528, 0.536, 0.586, 0.544, 0.528, 0.526, 0.538, 0.546, 0.508,
    #     #         0.496, 0.508, 0.524, 0.524, 0.5, 0.528, 0.53, 0.524, 0.512, 0.514, 0.478, 0.484, 0.464, 0.496, 0.52]
    #     # # rkrum = 17951947837
    #     # # krum = 17834721988
    #     # # mean = 17843289066
    #
    # elif case == 'case 2':
    #     # Case 2: In each training round, a random number of clients m are selected to participate,
    #     # where m is uniformly drawn from [1, 20].
    #     # # random seed = 0
    #     # rkrum = [0.77, 0.756, 0.784, 0.766, 0.776, 0.79, 0.762, 0.788, 0.776, 0.77, 0.758, 0.736, 0.772, 0.754, 0.778,
    #     #          0.768, 0.768, 0.762, 0.746, 0.54, 0.552, 0.562, 0.56, 0.538, 0.534, 0.542, 0.548, 0.546, 0.546, 0.544]
    #     # krum = [0.73, 0.788, 0.784, 0.77, 0.78, 0.514, 0.516, 0.522, 0.532, 0.548, 0.54, 0.536, 0.538, 0.548, 0.548, 0.548,
    #     #         0.55, 0.548, 0.55, 0.488, 0.486, 0.486, 0.482, 0.494, 0.498, 0.506, 0.51, 0.516, 0.51, 0.516]
    #     # mean = [0.516, 0.498, 0.468, 0.492, 0.516, 0.494, 0.502, 0.504, 0.524, 0.51, 0.518, 0.528, 0.542, 0.534, 0.53, 0.5,
    #     #         0.488, 0.502, 0.492, 0.44, 0.442, 0.464, 0.454, 0.466, 0.458, 0.446, 0.434, 0.444, 0.438, 0.448]
    #     #
    #     # # random seed = 100
    #     # rkrum = [0.744, 0.772, 0.774, 0.782, 0.766, 0.77, 0.772, 0.772, 0.598, 0.598, 0.528, 0.518, 0.516, 0.51, 0.52,
    #     #          0.522, 0.512, 0.522, 0.528, 0.52, 0.526, 0.524, 0.528, 0.532, 0.532, 0.524, 0.524, 0.526, 0.518, 0.516]
    #     # krum = [0.75, 0.782, 0.784, 0.772, 0.78, 0.766, 0.774, 0.786, 0.51, 0.508, 0.496, 0.504, 0.484, 0.482, 0.442, 0.45,
    #     #         0.448, 0.438, 0.444, 0.444, 0.444, 0.456, 0.458, 0.466, 0.476, 0.494, 0.492, 0.492, 0.486, 0.482]
    #     # mean = [0.48, 0.508, 0.566, 0.482, 0.478, 0.556, 0.534, 0.536, 0.498, 0.5, 0.49, 0.486, 0.488, 0.486, 0.466, 0.47,
    #     #         0.468, 0.472, 0.466, 0.476, 0.48, 0.486, 0.488, 0.492, 0.488, 0.474, 0.472, 0.472, 0.458, 0.454]
    #     #
    #     # # # random seed = 200
    #     # rkrum = [0.468, 0.462, 0.47, 0.47, 0.472, 0.488, 0.494, 0.504, 0.524, 0.52, 0.522, 0.518, 0.524, 0.53, 0.536, 0.534,
    #     #          0.534, 0.538, 0.466, 0.458, 0.444, 0.444, 0.44, 0.454, 0.44, 0.45, 0.456, 0.456, 0.448, 0.458]
    #     # krum = [0.514, 0.52, 0.52, 0.528, 0.52, 0.528, 0.526, 0.53, 0.538, 0.548, 0.55, 0.552, 0.552, 0.544, 0.542, 0.538,
    #     #         0.54, 0.536, 0.478, 0.48, 0.476, 0.482, 0.478, 0.478, 0.48, 0.478, 0.476, 0.48, 0.476, 0.48]
    #     # mean = [0.478, 0.496, 0.478, 0.478, 0.452, 0.466, 0.474, 0.486, 0.496, 0.532, 0.542, 0.518, 0.546, 0.532, 0.524,
    #     #         0.52, 0.474, 0.484, 0.472, 0.44, 0.458, 0.436, 0.446, 0.466, 0.492, 0.492, 0.476, 0.47, 0.48, 0.48]
    #
    #     # # random seed = 300
    #     rkrum = [0.74, 0.742, 0.742, 0.76, 0.768, 0.76, 0.75, 0.78, 0.746, 0.756, 0.762, 0.746, 0.77, 0.5, 0.506, 0.518,
    #              0.52, 0.516, 0.522, 0.522, 0.528, 0.532, 0.488, 0.494, 0.494, 0.498, 0.502, 0.502, 0.512, 0.504]
    #     krum = [0.748, 0.768, 0.792, 0.798, 0.788, 0.776, 0.776, 0.774, 0.768, 0.782, 0.764, 0.786, 0.756, 0.486, 0.474,
    #             0.48, 0.482, 0.48, 0.494, 0.498, 0.498, 0.49, 0.49, 0.478, 0.488, 0.488, 0.506, 0.504, 0.5, 0.504]
    #     mean = [0.55, 0.52, 0.526, 0.536, 0.558, 0.506, 0.496, 0.53, 0.51, 0.482, 0.476, 0.47, 0.494, 0.466, 0.466, 0.506,
    #             0.508, 0.496, 0.502, 0.516, 0.484, 0.484, 0.482, 0.492, 0.482, 0.494, 0.462, 0.482, 0.478, 0.486]
    #
    #     # # random seed = 400
    #     # rkrum = [0.742, 0.758, 0.792, 0.766, 0.582, 0.526, 0.524, 0.524, 0.526, 0.526, 0.506, 0.506, 0.508, 0.524, 0.522,
    #     #          0.526, 0.524, 0.526, 0.526, 0.524, 0.522, 0.516, 0.516, 0.524, 0.522, 0.536, 0.526, 0.52, 0.522, 0.524]
    #     # krum = [0.752, 0.78, 0.776, 0.496, 0.456, 0.508, 0.51, 0.514, 0.52, 0.518, 0.47, 0.474, 0.474, 0.466, 0.46, 0.482,
    #     #         0.482, 0.486, 0.488, 0.49, 0.492, 0.486, 0.484, 0.484, 0.488, 0.484, 0.482, 0.48, 0.478, 0.484]
    #     # mean = [0.514, 0.522, 0.512, 0.47, 0.506, 0.478, 0.48, 0.474, 0.476, 0.48, 0.496, 0.5, 0.502, 0.484, 0.498, 0.492,
    #     #         0.492, 0.51, 0.49, 0.49, 0.494, 0.498, 0.468, 0.49, 0.466, 0.47, 0.448, 0.444, 0.5, 0.516]
    #
    # elif case == 'case 3':
    #     # # Bernoulli distribution:
    #
    #     # # ** *random_seed: 0
    #     # rkrum = [0.734, 0.748, 0.746, 0.742, 0.742, 0.758, 0.75, 0.76, 0.728, 0.712, 0.74, 0.73, 0.75, 0.762, 0.762,
    #     #          0.756, 0.76, 0.75, 0.76, 0.754, 0.732, 0.744, 0.744, 0.776, 0.736, 0.752, 0.756, 0.728, 0.752, 0.738]
    #     # krum = [0.764, 0.778, 0.786, 0.774, 0.766, 0.772, 0.762, 0.754, 0.764, 0.764, 0.754, 0.76, 0.756, 0.766, 0.77,
    #     #         0.774, 0.766, 0.768, 0.756, 0.76, 0.762, 0.768, 0.752, 0.746, 0.762, 0.746, 0.726, 0.722, 0.716, 0.738]
    #     # mean = [0.512, 0.48, 0.52, 0.546, 0.508, 0.448, 0.47, 0.508, 0.482, 0.484, 0.5, 0.52, 0.566, 0.492, 0.472,
    #     #         0.456, 0.474, 0.478, 0.476, 0.472, 0.44, 0.454, 0.484, 0.508, 0.49, 0.496, 0.516, 0.518, 0.532, 0.548]
    #     # # rkrum = 37002338702
    #     # # krum = 17364799936
    #     # # mean = 17484431290
    #
    #     # # ** *random_seed: 100
    #     # rkrum = [0.75, 0.786, 0.758, 0.776, 0.774, 0.762, 0.772, 0.752, 0.766, 0.768, 0.76, 0.77, 0.748, 0.74, 0.752,
    #     #          0.736, 0.75, 0.754, 0.742, 0.764, 0.718, 0.698, 0.716, 0.73, 0.716, 0.73, 0.728, 0.736, 0.734, 0.742]
    #     # krum = [0.75, 0.76, 0.764, 0.78, 0.786, 0.774, 0.782, 0.774, 0.772, 0.76, 0.776, 0.78, 0.774, 0.77, 0.774,
    #     #         0.762, 0.764, 0.742, 0.746, 0.744, 0.766, 0.73, 0.726, 0.738, 0.716, 0.734, 0.728, 0.754, 0.738, 0.754]
    #     # mean = [0.478, 0.484, 0.482, 0.49, 0.506, 0.454, 0.518, 0.526, 0.536, 0.514, 0.494, 0.474, 0.486, 0.454, 0.476,
    #     #         0.494, 0.49, 0.508, 0.478, 0.5, 0.484, 0.49, 0.492, 0.498, 0.522, 0.542, 0.554, 0.548, 0.508, 0.542]
    #     # # rkrum = 18074010611
    #     # # krum = 17961631764
    #     # # mean = 17835485843
    #
    #     # # ** *random_seed: 200
    #     # rkrum = [0.744, 0.78, 0.76, 0.778, 0.778, 0.764, 0.768, 0.76, 0.798, 0.772, 0.76, 0.758, 0.78, 0.77, 0.776,
    #     #          0.758, 0.782, 0.746, 0.784, 0.752, 0.73, 0.762, 0.762, 0.748, 0.752, 0.756, 0.744, 0.754, 0.74, 0.752]
    #     # krum = [0.744, 0.772, 0.782, 0.768, 0.79, 0.778, 0.76, 0.78, 0.764, 0.784, 0.76, 0.77, 0.772, 0.778, 0.752,
    #     #         0.77, 0.772, 0.766, 0.754, 0.744, 0.742, 0.744, 0.734, 0.728, 0.744, 0.75, 0.75, 0.716, 0.736, 0.748]
    #     # mean = [0.488, 0.514, 0.464, 0.46, 0.498, 0.5, 0.502, 0.512, 0.558, 0.534, 0.552, 0.542, 0.546, 0.542, 0.558,
    #     #         0.582, 0.578, 0.572, 0.572, 0.578, 0.526, 0.524, 0.536, 0.542, 0.542, 0.528, 0.546, 0.548, 0.556, 0.59]
    #     # # rkrum = 17978956096
    #     # # krum = 17834761094
    #     # # mean = 17915135597
    #
    #     # ** *random_seed: 300
    #     rkrum = [0.75, 0.754, 0.758, 0.802, 0.772, 0.75, 0.75, 0.786, 0.786, 0.762, 0.782, 0.792, 0.756, 0.742, 0.748,
    #              0.762, 0.768, 0.756, 0.768, 0.756, 0.77, 0.744, 0.756, 0.748, 0.754, 0.74, 0.756, 0.754, 0.752, 0.746]
    #     krum = [0.75, 0.776, 0.778, 0.77, 0.784, 0.768, 0.768, 0.766, 0.782, 0.756, 0.772, 0.754, 0.764, 0.77, 0.756,
    #             0.734, 0.718, 0.708, 0.732, 0.706, 0.722, 0.72, 0.72, 0.734, 0.718, 0.742, 0.71, 0.72, 0.73, 0.728]
    #     mean = [0.504, 0.564, 0.54, 0.496, 0.54, 0.548, 0.548, 0.538, 0.556, 0.53, 0.504, 0.492, 0.5, 0.478, 0.532,
    #             0.56, 0.528, 0.462, 0.486, 0.486, 0.504, 0.458, 0.49, 0.538, 0.512, 0.5, 0.522, 0.524, 0.516, 0.534]
    #     # rkrum = 17830625628
    #     # krum = 17789149045
    #     # mean = 17771244071
    #
    #     # # ** *random_seed: 400
    #     # rkrum = [0.746, 0.75, 0.772, 0.768, 0.758, 0.758, 0.736, 0.752, 0.75, 0.768, 0.764, 0.762, 0.748, 0.742, 0.74,
    #     #          0.75, 0.75, 0.748, 0.77, 0.758, 0.758, 0.746, 0.748, 0.762, 0.748, 0.744, 0.746, 0.76, 0.758, 0.756]
    #     # krum = [0.756, 0.76, 0.768, 0.764, 0.75, 0.782, 0.782, 0.784, 0.764, 0.78, 0.766, 0.762, 0.768, 0.754, 0.776,
    #     #         0.768, 0.74, 0.738, 0.744, 0.78, 0.772, 0.774, 0.748, 0.756, 0.762, 0.736, 0.756, 0.744, 0.748, 0.756]
    #     # mean = [0.53, 0.5, 0.53, 0.538, 0.546, 0.53, 0.494, 0.516, 0.534, 0.518, 0.538, 0.496, 0.52, 0.508, 0.496, 0.48,
    #     #         0.488, 0.488, 0.524, 0.522, 0.528, 0.512, 0.502, 0.482, 0.518, 0.52, 0.492, 0.488, 0.504, 0.504]
    #     # # rkrum = 17076804308
    #     # # krum = 17074400609
    #     # # mean = 17092936865
    #
    #
    # else:
    #     raise ValueError('Case 3 is not implemented.')
    #
    for dropout_type in ['random', 'random_m', 'bernoulli', 'markov']:
        DATASET = 'SENTMENT140'
        # dropout_type ='random_m' #'bernoulli' # 'bernoulli'  #'markov',
        # random and random_m, 'bernoulli' and  'markov' use random seed 300
        # result_file = f'out/Results_20250730/{dropout_type}.pkl'
        # result_file = f'out/Results_20250903/{dropout_type}.pkl'
        result_file = f'out/{dropout_type}.pkl'
        with open(result_file, 'rb') as f:
            results = pickle.load(f)

        aggregate_methods = ['rkrum', 'krum', 'mean']
        RANDOM_SEEDS = list(results['rkrum'].keys())
        print(RANDOM_SEEDS)
        for metric in ['accs', 'time']:
            print(f'\nmetric: {metric}')
            data = {}
            for aggregate_method in aggregate_methods:
                Verbose = 10
                if Verbose >= 10:
                    for random_seed in RANDOM_SEEDS:
                        print(f'{aggregate_method}_{metric}_{random_seed} = ',
                              results[aggregate_method][random_seed][metric])
                show_avg = False
                if show_avg:
                    res = np.array([results[aggregate_method][random_seed][metric] for random_seed in RANDOM_SEEDS])
                    res = np.mean(res, axis=0)
                else:
                    # only show one random seed result
                    random_seed = 300
                    res = results[aggregate_method][random_seed][metric]
                print(f'{aggregate_method}_{metric} = ', res)
                data[aggregate_method] = res
            #
            # results = {
            #     'rkrum': rkrum,
            #     'krum': krum,
            #     'mean': mean
            # }
            if metric == 'accs':
                FILENAME = f'{DATASET}/{dropout_type}'
                result_file = f'plots/{FILENAME}'
                os.makedirs(os.path.dirname(result_file), exist_ok=True)

                csv_file = result_file + '.csv'
                with open(csv_file, 'w') as f:
                    for k, vs in data.items():
                        if k == 'rkrum':
                            label = 'rKrum'
                        elif k == 'krum':
                            label = 'Krum'
                        elif k == 'mean':
                            label = 'Mean'
                        else:
                            raise ValueError
                        f.write(f'{label},' + ','.join([str(v) for v in vs]) + '\n')

                # Read CSV
                df = pd.read_csv(csv_file, header=None)
                # Save as Excel
                df.to_excel(result_file + '.xlsx', index=False)
                os.remove(csv_file)

                # plot the data
                plot_dropout(data)


